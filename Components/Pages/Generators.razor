@page "/generators"
@using DataGen_v1.Data
@using DataGen_v1.Models
@using DataGen_v1.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.FluentUI.AspNetCore.Components
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject GenerationManager GenManager
@implements IDisposable

@rendermode InteractiveServer

<PageTitle>My Generators</PageTitle>

<div style="width: 100%; padding: 20px;">
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">

        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
            <h2 style="margin: 0;">My Generators</h2>
            <FluentSpacer />
            <FluentButton Appearance="Appearance.Accent" OnClick="@(() => ShowCreate = true)" IconStart="@(new Icons.Regular.Size20.Add())">
                New Project
            </FluentButton>
        </FluentStack>

        <FluentGrid Spacing="3" AdaptiveRendering="true" Style="width: 100%;">
            @foreach (var gen in GeneratorList)
            {
                // Check status dynamically
                bool isRunning = GenManager.IsRunning(gen.Id);

                <FluentGridItem xs="12" sm="6" md="4" lg="3">
                    <FluentCard Style="@GetCardStyle(isRunning)">

                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div style="flex-grow: 1; overflow: hidden;">
                                <h3 style="margin: 0 0 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @gen.Name
                                </h3>
                            </div>
                            @if (isRunning)
                            {
                                <FluentBadge Appearance="Appearance.Accent" Color="Color.Success">Running</FluentBadge>
                            }
                            else
                            {
                                <FluentBadge Appearance="Appearance.Neutral">Stopped</FluentBadge>
                            }
                        </div>

                        <p style="color: #bbb; font-size: 0.9em; height: 40px; overflow: hidden;">
                            @gen.Description
                        </p>

                        <div style="font-size: 0.8em; color: #888; margin-bottom: 10px;">
                            Speed: @gen.IntervalMs ms
                        </div>

                        <FluentDivider />

                        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.End" Style="margin-top: 15px;">

                            @if (isRunning)
                            {
                                <FluentButton Appearance="Appearance.Accent" Color="Color.Error"
                                              OnClick="@(() => ToggleGen(gen.Id))"
                                              IconStart="@(new Icons.Regular.Size16.Stop())">Stop</FluentButton>
                            }
                            else
                            {
                                <FluentButton Appearance="Appearance.Neutral"
                                              OnClick="@(() => ToggleGen(gen.Id))"
                                              IconStart="@(new Icons.Regular.Size16.Play())">Run</FluentButton>
                            }

                            <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => OpenGen(gen.Id))">Edit</FluentButton>

                            @if (!isRunning)
                            {
                                <FluentButton Appearance="Appearance.Stealth" OnClick="@(() => DeleteGen(gen))" IconStart="@(new Icons.Regular.Size16.Delete())" />
                            }
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
            }
        </FluentGrid>
    </FluentStack>
</div>

@code {
    private List<Generator> GeneratorList = new();
    private Generator NewGen = new();
    private bool ShowCreate = false;
    private System.Threading.Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadGenerators();

        // Polling Timer: Updates the UI every 2 seconds to reflect running state
        // This ensures if you open this page in two tabs, they both see the correct status.
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(StateHasChanged);
        }, null, 1000, 2000);
    }

    private async Task LoadGenerators()
    {
        using var context = DbFactory.CreateDbContext();
        GeneratorList = await context.Generators.AsNoTracking().ToListAsync();
    }

    private void ToggleGen(int id)
    {
        if (GenManager.IsRunning(id))
            GenManager.StopGeneration(id);
        else
            GenManager.StartGeneration(id);

        StateHasChanged();
    }

    private string GetCardStyle(bool isRunning)
    {
        string border = isRunning ? "border: 1px solid #13a10e;" : "border: 1px solid transparent;";
        return $"height: 220px; display: flex; flex-direction: column; background-color: #252525; {border} transition: all 0.3s;";
    }

    private void OpenGen(int id) => Nav.NavigateTo($"/generator/{id}");

    private async Task DeleteGen(Generator gen)
    {
        if (GenManager.IsRunning(gen.Id)) return; // Prevent deleting running gens

        using var context = DbFactory.CreateDbContext();
        var nodesToDelete = context.NodeConfigs.Where(n => n.GeneratorId == gen.Id);
        context.NodeConfigs.RemoveRange(nodesToDelete);
        context.Generators.Remove(gen);
        await context.SaveChangesAsync();
        await LoadGenerators();
    }

    // CreateGen method stays the same...

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}